<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚òï Caff√® 8-Bit</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background-color: #000;
            color: #0f0;
            font-size: 14px;
            overflow: hidden;
            text-shadow: 1px 1px 0 #000;
        }

        .game-container {
            max-width: 1000px;
            margin: 10px auto;
            padding: 10px;
            border: 4px solid #333;
            position: relative;
        }

        .crt-effect {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, rgba(10, 20, 5, 0.05), rgba(10, 20, 5, 0.05) 1px, transparent 1px, transparent 2px);
            z-index: 9999;
            opacity: 0.3;
            mix-blend-mode: overlay;
        }

        .title {
            text-align: center;
            margin: 10px 0;
            font-size: 1.4em;
            color: #0f0;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 1px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            font-size: 0.7em;
        }

        .stat {
            background: #111;
            border: 2px solid #0f0;
            padding: 6px;
            border-radius: 0;
            text-align: center;
            min-width: 80px;
            color: #0f0;
        }

        .stat-value {
            font-size: 1.2em;
            color: #0f0;
        }

        .bar-map {
            width: 100%;
            height: 400px;
            background-color: #111;
            border: 3px solid #542;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .pixel-border {
            border: 2px solid #542;
            border-radius: 0;
        }

        .coffee-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 40px;
            background-color: #321;
            border: 2px solid #542;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: #ff0;
            letter-spacing: 1px;
        }

        .machine {
            position: absolute;
            bottom: 20px;
            width: 80px;
            height: 60px;
            background-color: #321;
            border: 2px solid #542;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            color: #ff0;
            user-select: none;
        }

        #espressoMachine { left: 40px; }
        #milkMachine { right: 40px; }

        .machine.active {
            border-color: #f00;
            background-color: #500;
        }

        .machine-label {
            font-size: 0.6em;
            text-align: center;
            white-space: nowrap;
        }

        .machine-status {
            font-size: 0.5em;
            background: #111;
            padding: 2px 4px;
            border: 1px solid #542;
            color: #0f0;
        }

        .seating-area {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 60px;
            background-color: #111;
            border: 1px dashed #542;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #542;
            font-size: 0.6em;
        }

        .entrance, .exit {
            position: absolute;
            top: 50%;
            width: 10px;
            height: 60px;
            transform: translateY(-50%);
            border: 1px solid #000;
        }

        .entrance { right: 0; background: #0f0; }
        .exit { left: 0; background: #f00; }

        .customer {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #333;
            border: 1px solid #542;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            cursor: pointer;
            color: #fff;
            z-index: 10;
        }

        .customer.ordering {
            border-color: #ff0;
            background-color: #440;
            transform: scale(1.2);
        }

        .customer.angry {
            border-color: #f00;
            background-color: #500;
            animation: blink 0.5s step-start infinite;
        }

        .customer.served {
            border-color: #0f0;
            background-color: #040;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.6; }
        }

        .order-bubble {
            position: absolute;
            background: #111;
            border: 1px solid #0f0;
            padding: 4px;
            font-size: 0.5em;
            pointer-events: none;
            z-index: 20;
            white-space: nowrap;
            top: -30px;
            left: -40px;
            color: #0f0;
        }

        .timer-bar {
            width: 100%;
            height: 2px;
            background: #f00;
            margin-top: 2px;
        }

        .controls, .game-over, .victory {
            background: #111;
            border: 2px solid #0f0;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.7em;
            line-height: 1.4;
        }

        .start-button {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 20px;
            margin: 10px;
            font-family: 'Press Start 2P', monospace;
            cursor: pointer;
            font-size: 0.8em;
        }

        .start-button:hover {
            background: #0f0;
            color: #000;
        }

        .difficulty-button {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 6px 10px;
            margin: 5px;
            font-family: 'Press Start 2P', monospace;
            cursor: pointer;
            font-size: 0.7em;
        }

        .difficulty-button.active {
            background: #0f0;
            color: #000;
        }

        .game-over {
            border-color: #f00;
            color: #f00;
        }

        .victory {
            border-color: #0f0;
            color: #0f0;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.6em;
        }

        .legend-item {
            background: #111;
            border: 1px solid #542;
            padding: 6px;
            text-align: center;
        }

        .floating-text {
            position: absolute;
            font-size: 0.9em;
            font-weight: bold;
            pointer-events: none;
            color: #0f0;
            z-index: 1000;
            animation: float 1.5s ease-out forwards;
        }

        @keyframes float {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        .highscore {
            color: #ff0;
            font-size: 0.6em;
            margin-top: 4px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .bar-map { height: 300px; }
            .title { font-size: 1em; }
            .stat { font-size: 0.6em; }
            .customer { width: 20px; height: 20px; font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <div class="crt-effect"></div>
    <div class="game-container">
        <div class="title">‚òï CAFF√à 8-BIT</div>

        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="clientsServed">0</div>
                SERVITI
            </div>
            <div class="stat">
                <div class="stat-value" id="clientsTarget">15</div>
                OBIETTIVO
            </div>
            <div class="stat">
                <div class="stat-value" id="activeClients">0</div>
                IN GIOCO
            </div>
            <div class="stat">
                <div class="stat-value" id="baristaPoints">0</div>
                PUNTI
            </div>
        </div>

        <div id="gameOverScreen" class="game-over" style="display: none;">
            <h2>üíÄ CAOS!</h2>
            <p>PUNTI: <span id="earnedPoints">0</span></p>
            <p class="highscore">Record: <span id="recordGameover">0</span></p>
            <button class="start-button" onclick="showControls()">üîÑ RICOMINCIA</button>
        </div>

        <div id="victoryScreen" class="victory" style="display: none;">
            <h2>üèÜ PERFETTO!</h2>
            <p>PUNTI: <span id="victoryPoints">0</span></p>
            <p class="highscore">Record: <span id="recordVictory">0</span></p>
            <button class="start-button" onclick="showControls()">‚û°Ô∏è AVANTI</button>
        </div>

        <div class="controls" id="controlsScreen">
            <h3>üéÆ DIFFICOLT√Ä</h3>
            <div>
                <button class="difficulty-button active" onclick="setDifficulty('easy')" id="easyBtn">üòä FACILE</button>
                <button class="difficulty-button" onclick="setDifficulty('normal')" id="normalBtn">üòê NORMALE</button>
                <button class="difficulty-button" onclick="setDifficulty('hard')" id="hardBtn">üò∞ DIFFICILE</button>
                <button class="difficulty-button" onclick="setDifficulty('expert')" id="expertBtn">ü§Ø ESPERTO</button>
            </div>
            <div style="margin-top: 10px; font-size: 0.6em; color: #ff0;">
                Record: 
                <span id="currentRecord">Nessuno</span>
            </div>
            <button class="start-button" onclick="startGame()">‚ñ∂Ô∏è INIZIA</button>
            <div style="margin-top: 15px;">
                <p>‚Ä¢ Clicca sul cliente che ordina</p>
                <p>‚Ä¢ Usa le macchine nell'ordine</p>
                <p>‚Ä¢ Evita che si arrabbino!</p>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">üü® Ordina</div>
            <div class="legend-item">üü• Arrabbiato</div>
            <div class="legend-item">üü© Servito</div>
            <div class="legend-item">üü¢ Entrata</div>
            <div class="legend-item">üî¥ Uscita</div>
        </div>

        <div class="bar-map pixel-border" id="barMap" style="display: none;">
            <div class="entrance"></div>
            <div class="exit"></div>
            <div class="seating-area">SEDI</div>
            <div class="coffee-counter">BANCO</div>

            <div class="machine pixel-border" id="espressoMachine">
                <div class="machine-label">ESPRESSO</div>
                <div class="machine-status" id="espressoStatus">PRONTA</div>
            </div>

            <div class="machine pixel-border" id="milkMachine">
                <div class="machine-label">LATTE</div>
                <div class="machine-status" id="milkStatus">PRONTA</div>
            </div>
        </div>
    </div>

    <script>
        // Audio Context
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playTone(frequency, duration, type = 'square', volume = 0.1) {
            const osc = audioCtx.createOscillator();
            const amp = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = frequency;
            amp.gain.value = volume;
            osc.connect(amp);
            amp.connect(audioCtx.destination);
            osc.start();
            setTimeout(() => osc.stop(), duration);
        }

        // Suoni predefiniti
        const sounds = {
            click: () => playTone(300, 100, 'sine'),
            machine: () => playTone(200, 80, 'square'),
            success: () => {
                playTone(400, 100);
                setTimeout(() => playTone(500, 150), 120);
            },
            error: () => playTone(100, 300, 'sawtooth', 0.15),
            victory: () => {
                playTone(400, 150);
                setTimeout(() => playTone(500, 150), 160);
                setTimeout(() => playTone(600, 200), 320);
            },
            gameOver: () => {
                playTone(200, 200);
                setTimeout(() => playTone(150, 300), 220);
            }
        };

        // Gestione punteggi locali
        function getHighScore(difficulty) {
            return parseInt(localStorage.getItem(`highscore_${difficulty}`)) || 0;
        }

        function saveHighScore(difficulty, score) {
            const current = getHighScore(difficulty);
            if (score > current) {
                localStorage.setItem(`highscore_${difficulty}`, score.toString());
            }
        }

        function updateHighScoreDisplay() {
            const recordSpan = document.getElementById('currentRecord');
            const hs = getHighScore(gameState.difficulty);
            recordSpan.textContent = `${hs} punti`;
        }

        const COFFEE_TYPES = {
            'Espresso': { emoji: '‚òï', espresso: 2, milk: 0, time: 8, points: 10 },
            'Americano': { emoji: '‚òï', espresso: 1, milk: 0, time: 6, points: 12 },
            'Cappuccino': { emoji: 'ü´ß', espresso: 2, milk: 3, time: 12, points: 20 },
            'Latte': { emoji: 'ü•õ', espresso: 1, milk: 4, time: 10, points: 18 },
            'Macchiato': { emoji: 'ü§é', espresso: 3, milk: 1, time: 9, points: 22 },
            'Flat White': { emoji: '‚ö™', espresso: 3, milk: 5, time: 15, points: 30 }
        };

        const DIFFICULTIES = {
            easy: { target: 15, spawnRate: 0.5, speed: 1, max: 5 },
            normal: { target: 25, spawnRate: 0.7, speed: 1.4, max: 7 },
            hard: { target: 35, spawnRate: 0.9, speed: 1.8, max: 9 },
            expert: { target: 50, spawnRate: 1.2, speed: 2.2, max: 11 }
        };

        let gameState = {
            isPlaying: false,
            difficulty: 'easy',
            clientsServed: 0,
            baristaPoints: 0,
            customers: [],
            customerIdCounter: 0,
            activeOrderCustomer: null
        };

        const customerEmojis = ['üë§', 'üßë', 'üë¶', 'üëß', 'üë¥', 'üëµ', 'üëÆ', 'üßô'];

        const MAP_WIDTH = 960;
        const MAP_HEIGHT = 360;

        class Customer {
            constructor() {
                this.id = gameState.customerIdCounter++;
                this.emoji = customerEmojis[Math.floor(Math.random() * customerEmojis.length)];
                this.x = MAP_WIDTH + 30;
                this.y = 100 + Math.random() * 200;
                this.state = 'entering';
                this.coffeeType = Object.keys(COFFEE_TYPES)[Math.floor(Math.random() * Object.keys(COFFEE_TYPES).length)];
                this.maxPatience = COFFEE_TYPES[this.coffeeType].time * 60;
                this.patience = this.maxPatience;
                this.espressoNeeded = COFFEE_TYPES[this.coffeeType].espresso;
                this.milkNeeded = COFFEE_TYPES[this.coffeeType].milk;
                this.espressoDone = 0;
                this.milkDone = 0;
                this.orderPhase = 'waiting';
                this.stateTimer = 0;
                this.speed = DIFFICULTIES[gameState.difficulty].speed;
                this.targetX = 0;
                this.targetY = 0;
                this.element = null;
                this.orderBubble = null;
                this.chooseDestination();
                this.create();
            }

            create() {
                this.element = document.createElement('div');
                this.element.className = 'customer';
                this.element.textContent = this.emoji;
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
                this.element.addEventListener('click', () => this.click());
                document.getElementById('barMap').appendChild(this.element);
            }

            click() {
                if (this.state === 'ordering' && this.orderPhase === 'waiting') {
                    this.orderPhase = 'espresso';
                    gameState.activeOrderCustomer = this;
                    this.updateBubble();
                    document.getElementById('espressoMachine').classList.add('active');
                    document.getElementById('espressoStatus').textContent = 'IN CORSO';
                    sounds.click();
                }
            }

            complete() {
                this.state = 'served';
                this.element.classList.add('served');
                this.element.classList.remove('ordering');
                gameState.clientsServed++;
                gameState.baristaPoints += COFFEE_TYPES[this.coffeeType].points;
                gameState.activeOrderCustomer = null;
                document.getElementById('espressoMachine').classList.remove('active');
                document.getElementById('milkMachine').classList.remove('active');
                document.getElementById('espressoStatus').textContent = 'PRONTA';
                document.getElementById('milkStatus').textContent = 'PRONTA';
                createFloatingText(`+${COFFEE_TYPES[this.coffeeType].points}`, '#0f0', this.x, this.y);
                sounds.success();
                setTimeout(() => { this.state = 'leaving'; this.targetX = -50; }, 1500);
                this.removeBubble();
            }

            update() {
                this.stateTimer++;

                const dx = this.targetX - this.x;
                const dy = this.targetY - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);

                if (dist > 5 && !['sitting','ordering','served','angry'].includes(this.state)) {
                    this.x += (dx / dist) * this.speed;
                    this.y += (dy / dist) * this.speed;
                    this.element.style.left = this.x + 'px';
                    this.element.style.top = this.y + 'px';
                }

                switch (this.state) {
                    case 'entering':
                        if (this.x < MAP_WIDTH - 50) this.state = 'walking';
                        else this.x -= this.speed;
                        break;
                    case 'walking':
                        if (dist < 20) {
                            if (Math.random() < 0.6) {
                                this.state = 'sitting';
                                this.stateTimer = 0;
                            } else this.chooseDestination();
                        }
                        break;
                    case 'sitting':
                        if (this.stateTimer > 100 && Math.random() < 0.7) {
                            this.state = 'ordering';
                            this.element.classList.add('ordering');
                            this.showBubble();
                        }
                        break;
                    case 'ordering':
                        this.patience--;
                        this.updateBubble();
                        if (this.patience <= 0) this.angry();
                        break;
                    case 'leaving':
                    case 'served':
                    case 'angry':
                        if (this.x < -40) this.destroy();
                        break;
                }
            }

            chooseDestination() {
                this.targetX = 100 + Math.random() * 700;
                this.targetY = 100 + Math.random() * 200;
            }

            showBubble() {
                this.orderBubble = document.createElement('div');
                this.orderBubble.className = 'order-bubble';
                this.updateBubble();
                this.element.appendChild(this.orderBubble);
            }

            updateBubble() {
                if (!this.orderBubble) return;
                const c = COFFEE_TYPES[this.coffeeType];
                const emoji = c.emoji;
                const p = Math.max(0, this.patience / this.maxPatience * 100);
                let status = '', progress = '';
                if (this.orderPhase === 'waiting') {
                    status = `${emoji} ${this.coffeeType}`;
                    progress = 'CLICCA!';
                } else if (this.orderPhase === 'espresso') {
                    status = 'ESPRESSO';
                    progress = `${this.espressoDone}/${this.espressoNeeded}`;
                } else if (this.orderPhase === 'milk') {
                    status = 'LATTE';
                    progress = `${this.milkDone}/${this.milkNeeded}`;
                }
                this.orderBubble.innerHTML = `${status}<div class="timer-bar" style="width:${p}%"></div>`;
            }

            removeBubble() {
                if (this.orderBubble) this.orderBubble.remove();
                this.orderBubble = null;
            }

            angry() {
                this.state = 'angry';
                this.element.classList.add('angry');
                this.element.classList.remove('ordering');
                if (gameState.activeOrderCustomer === this) {
                    document.getElementById('espressoMachine').classList.remove('active');
                    document.getElementById('espressoStatus').textContent = 'PRONTA';
                    document.getElementById('milkMachine').classList.remove('active');
                    document.getElementById('milkStatus').textContent = 'PRONTA';
                    gameState.activeOrderCustomer = null;
                }
                this.removeBubble();
                sounds.error();
            }

            destroy() {
                if (this.element) this.element.remove();
                const i = gameState.customers.indexOf(this);
                if (i > -1) gameState.customers.splice(i, 1);
            }
        }

        function createFloatingText(text, color, x, y) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.textContent = text;
            el.style.color = color;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.getElementById('barMap').appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        function spawn() {
            if (gameState.customers.length < DIFFICULTIES[gameState.difficulty].max) {
                gameState.customers.push(new Customer());
            }
        }

        function updateUI() {
            document.getElementById('clientsServed').textContent = gameState.clientsServed;
            document.getElementById('clientsTarget').textContent = DIFFICULTIES[gameState.difficulty].target;
            document.getElementById('activeClients').textContent = gameState.customers.length;
            document.getElementById('baristaPoints').textContent = gameState.baristaPoints;
        }

        function gameLoop() {
            if (!gameState.isPlaying) return;
            gameState.customers.forEach(c => c.update());
            if (Math.random() < DIFFICULTIES[gameState.difficulty].spawnRate / 100) spawn();
            if (gameState.clientsServed >= DIFFICULTIES[gameState.difficulty].target) victory();
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function setDifficulty(d) {
            gameState.difficulty = d;
            document.querySelectorAll('.difficulty-button').forEach(b => b.classList.remove('active'));
            document.getElementById(d + 'Btn').classList.add('active');
            updateHighScoreDisplay();
        }

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            gameState.isPlaying = true;
            gameState.clientsServed = 0;
            gameState.baristaPoints = 0;
            gameState.customers = [];
            gameState.customerIdCounter = 0;
            gameState.activeOrderCustomer = null;

            document.getElementById('controlsScreen').style.display = 'none';
            document.getElementById('barMap').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('victoryScreen').style.display = 'none';

            for (let i = 0; i < 2; i++) setTimeout(spawn, i * 2000);

            gameLoop();
        }

        function gameOver() {
            gameState.isPlaying = false;
            sounds.gameOver();
            saveHighScore(gameState.difficulty, gameState.baristaPoints);
            const hs = getHighScore(gameState.difficulty);
            document.getElementById('earnedPoints').textContent = gameState.baristaPoints;
            document.getElementById('recordGameover').textContent = hs;
            document.getElementById('gameOverScreen').style.display = 'block';
            gameState.customers.forEach(c => c.destroy());
        }

        function victory() {
            gameState.isPlaying = false;
            sounds.victory();
            saveHighScore(gameState.difficulty, gameState.baristaPoints);
            const hs = getHighScore(gameState.difficulty);
            document.getElementById('victoryPoints').textContent = gameState.baristaPoints;
            document.getElementById('recordVictory').textContent = hs;
            document.getElementById('victoryScreen').style.display = 'block';
            gameState.customers.forEach(c => c.destroy());
        }

        function showControls() {
            document.getElementById('controlsScreen').style.display = 'block';
            document.getElementById('barMap').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('victoryScreen').style.display = 'none';
            updateHighScoreDisplay();
        }

        function setupMachines() {
            const espresso = document.getElementById('espressoMachine');
            const milk = document.getElementById('milkMachine');

            espresso.addEventListener('click', () => {
                if (gameState.activeOrderCustomer?.orderPhase === 'espresso') {
                    const c = gameState.activeOrderCustomer;
                    c.espressoDone++;
                    sounds.machine();
                    if (c.espressoDone >= c.espressoNeeded) {
                        if (c.milkNeeded > 0) {
                            c.orderPhase = 'milk';
                            espresso.classList.remove('active');
                            document.getElementById('espressoStatus').textContent = 'PRONTA';
                            milk.classList.add('active');
                            document.getElementById('milkStatus').textContent = 'IN CORSO';
                        } else {
                            c.complete();
                        }
                    }
                    c.updateBubble();
                }
            });

            milk.addEventListener('click', () => {
                if (gameState.activeOrderCustomer?.orderPhase === 'milk') {
                    const c = gameState.activeOrderCustomer;
                    c.milkDone++;
                    sounds.machine();
                    if (c.milkDone >= c.milkNeeded) {
                        c.complete();
                    }
                    c.updateBubble();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupMachines();
            updateHighScoreDisplay();
            showControls();
        });
    </script>
</body>
</html>